name: ğŸš€ Deploy Shugar Blood Bot

on:
  push:
    branches: [master]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      # ====================== CHECKOUT ======================
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ====================== BUILD STAGE ======================
      - name: ğŸ—ï¸ Build Docker image
        working-directory: ./backend
        run: |
          echo "::group::ğŸ“¦ Building backend image"
          docker build -t ghcr.io/alex-volkov-ru/shugar_blood_backend:latest .
          echo "::endgroup::"
      
      - name: ğŸš¢ Login to GitHub Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“¤ Push Docker image
        working-directory: ./backend
        run: |
          echo "::group::ğŸ“¤ Pushing image to GHCR"
          docker push ghcr.io/alex-volkov-ru/shugar_blood_backend:latest
          echo "::endgroup::"

      # ====================== DEPLOY STAGE ======================
      - name: ğŸ”‘ SSH Setup
        run: |
          echo "::group::ğŸ” Setting up SSH"
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -t rsa ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          echo "::endgroup::"

      - name: ğŸ› ï¸ Prepare Deployment
        run: |
          echo "::group::ğŸ§¹ Cleaning old containers"
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} \
            "cd /root/new_shugar_bot && docker-compose down --remove-orphans"
          echo "::endgroup::"
          
      - name: â¬‡ï¸ Pull Images on Server
        run: |
          echo "::group::ğŸ”½ Pulling new images"
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} \
            "cd /root/new_shugar_bot && docker-compose pull"
          echo "::endgroup::"

      - name: ğŸš€ Deploy Application
        run: |
          echo "::group::ğŸš€ Starting containers"
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} << 'EOF'
          set -e
          cd /root/new_shugar_bot
          docker-compose up -d --build
          EOF
          echo "::endgroup::"

      # ====================== VERIFICATION ======================
      - name: âœ… Verify Deployment
        run: |
          echo "::group::ğŸ” Checking running containers"
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} \
            "docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'"
          echo "::endgroup::"
          
          echo "::group::ğŸ”„ Health Check"
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} \
            "cd /root/new_shugar_bot && docker-compose ps"
          echo "::endgroup::"

      # ====================== NOTIFICATION ======================
      - name: ğŸ“¢ Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" = 'success' ]; then
            echo "::notice title=âœ… Deployment Successful::The application was deployed successfully"
          else
            echo "::error title=âŒ Deployment Failed::There were errors during deployment"
          fi